<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" class="search__text__input" placeholder="検索する" data-js="search-word">
          </div>
          <button class="search__btn" data-js="search-btn">検索する</button>
        </div>
        <div class="message" data-js="error-message"></div>
        <ul class="lists" data-js="book-lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script src="./js/appid.js"></script>
    <script>
    
    $( function() {//htmlファイルをすべて読み込んでから,関数を始めるというおまじない

      // 下記URLにAPIの仕様が載っているので、ブラウザで開いて参考にしてください。
      // https://webservice.rakuten.co.jp/api/bookstotalsearch/
      
      
      var val = '';//検索ワード用変数
      const start_page = 1;//修正③検索するを押した時に、必ず１ページ目から表示するため、そのフラグ
      var page = start_page;//ページ用変数,グローバル
      
      //修正①エラーメッセージ、ページャ、ブックリストを空にしてから、次のページを更新する。その関数
      //initialize:初期化するという意味
      function page_initialize() {
        $('ul[data-js="book-lists"]').empty();//ページャの削除
        $('div[data-js="error-message"]').empty();
        $('div[data-js="pager"]').remove();
      }

      //修正②同じdivタグにエラーメッセージを記載するので関数化した
      function output_error(err_message) {
        $('div[data-js="error-message"]').html('<p>' + err_message + '</p>');
      }

      function do_ajax() {
        $.ajax({
          url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
          type: 'GET',
          datatype: 'json',
          data: {
            // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
            applicationId: appId, //※メンターから別途渡されるファイルを読み込んでください。
            booksGenreId: '001',
            keyword: val ,
            hits: 20,
            page: page,
          },
        }).done(function(data) {
        
          page_initialize();

          if (data.count === 0){
            output_error('検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい');
          } else {
            var list_data='';
            $.each(data.Items,function(index,detail){
              list_data+=
              '<li class="lists__item">' +
                '<div class="lists__item__inner">' +
                  '<a href="' + detail.Item.itemUrl + '" class="lists__item__link" target="_blank">' +
                    '<img src="' + detail.Item.mediumImageUrl + '" class="lists__item__img" alt="">' +
                    '<p class="lists__item__detail">作品名：' + detail.Item.title + '</p>'+
                    '<p class="lists__item__detail">作者　：' + detail.Item.author + '</p>'+
                    '<p class="lists__item__detail">出版社：' + detail.Item.publisherName + '</p>'+
                  '</a>'+
                '</div>'+
              '</li>'
            });

            $('ul[data-js="book-lists"]').append(list_data);

            var option_class_pre = (data.page === start_page) ?  'disabled': '';//現在受け取ったページが１ページ目であるならば
            var option_class_next = (data.page === data.pageCount) ?  'disabled': '';//現在受け取ったページが最後のページであるならば

        
            $('ul[data-js="book-lists"]').after(
              '<div class="pager" data-js="pager">' +
                '<div class="counter">' +
                  '<span class="counter-current">' + data.page + '</span>/<span class="counter-all">' + data.pageCount + '</span>' +
                '</div>' +
                '<div class="btn-wrapper">' +
                  '<a class="btn-item ' + option_class_pre + '"data-js="page-prev" href="">前へ</a>' +
                  '<a class="btn-item ' + option_class_next + '"data-js="page-next" href="">次へ</a>' +
                '</div>' +
              '</div>'
            );
          }
          
        }).fail(function(err){

          page_initialize();

          if (err.status === 400){output_error('検索文字が入力されていません');}
          if (err.status === 429){output_error('リクエスト過多です。しばらく時間を置いてからお試しください。');}
          if (err.status === 0){output_error('通信に失敗しました。インターネットの接続をご確認ください。');}
          
        });

      }

      //前へをクリックした時のajax操作
      $(document).on('click','a[data-js="page-prev"]',function(event) {//ブラウザのページ全体をドキュメント、要素の検索、クリックイベント付与
        event.preventDefault();
        page--;
        do_ajax();
      });

      //次へをクリックした時ajax操作
      $(document).on('click','a[data-js="page-next"]',function(event) {
        event.preventDefault();
        page++;
        do_ajax();
      });
      ''

      //検索<button>タグがクリックされたら実行する。
      $('.search__btn').on('click',function() {

        //ブラウザ上で<input>要素の部分に入力した検索ワードを取得する。
        val = $('.search__text__input').val();

        page = start_page;

        do_ajax();//引数の削除
      });
    });
    </script>
  </body>
</html>
